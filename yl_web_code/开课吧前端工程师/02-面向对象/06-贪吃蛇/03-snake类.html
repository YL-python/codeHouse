<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #map {
        position: relative;
        width: 400px;
        height: 400px;
        background-color: #000;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <script>
      class Map {
        // 传参 元素和比例
        constructor(el, rect) {
          this.el = el
          this.rect = rect
          // 计算每行列多少个
          this.rows = Math.ceil(Map.getStyle(el, 'height') / rect)
          this.cells = Math.ceil(Map.getStyle(el, 'width') / rect)
          // 修复小细节
          Map.setStyle(el, 'height', rect * this.rows)
          Map.setStyle(el, 'width', rect * this.cells)
          this.data = []
        }
        static getStyle(el, attr) {
          return parseFloat(getComputedStyle(el)[attr])
        }
        static setStyle(el, attr, val) {
          el.style[attr] = val
        }
        // 向data中添加数据
        setData(newData) {
          this.data = this.data.concat(newData)
        }
        // 清空data
        clearData() {
          this.data.length = 0
        }
        // 判断data中是否包含
        include({ x, y }) {
          return !!this.data.some((item) => item.x == x && item.y == y)
        }
        // 渲染
        rander() {
          this.el.innerHTML = this.data
            .map((item) => {
              return `<span
                style="position:absolute;
                left:${item.x * this.rect}px;top:${item.y * this.rect}px;
                width:${this.rect}px;height:${this.rect}px;
                background:${item.color};"></span>`
            })
            .join('')
        }
      }
      class Food {
        constructor(map, colors = ['red', 'yellow', 'blue', 'pink']) {
          this.map = map
          this.colors = colors
          this.data = {}
          this.create()
        }
        // 随机创建一个食物
        create() {
          let x = Math.floor(Math.random() * this.map.cells)
          let y = Math.floor(Math.random() * this.map.rows)
          let color = this.colors[parseInt(Math.random() * this.colors.length)]
          this.data = { x, y, color }
          if (this.map.include(this.data)) {
            this.create()
          }
          this.map.setData(this.data)
        }
      }
      class Snake {
        constructor(map, food) {
          this.data = [
            { x: 5, y: 2, color: 'green' },
            { x: 4, y: 2, color: 'white' },
            { x: 3, y: 2, color: 'white' },
            { x: 2, y: 2, color: 'white' },
          ]
          this.map = map
          this.food = food
          this.map.setData(this.data)
          this.direction = 'right'
          this.lastData = {}
        }
        move() {
          let lastIndex = this.data.length - 1
          this.lastData = {
            x: this.data[lastIndex].x,
            y: this.data[lastIndex].y,
            color: this.data[lastIndex].color,
          }
          // 让最后一格走到第一格上
          for (let i = this.data.length - 1; i > 0; i--) {
            this.data[i].x = this.data[i - 1].x
            this.data[i].y = this.data[i - 1].y
          }
          switch (this.direction) {
            case 'left':
              this.data[0].x--
              break
            case 'right':
              this.data[0].x++
              break
            case 'top':
              this.data[0].y--
            case 'bottom':
              this.data[0].y++
              break
          }
        }
        changeDir(dir) {
          // 上下走的时候能左右调转方向
          if (this.direction === 'left' || this.direction === 'right') {
            if (dir === 'left' || dir === 'right') {
              return false
            }
          } else {
            // 左右走的时候能上下调转方向
            if (dir === 'top' || dir === 'bottom') {
              return false
            }
          }
          this.direction = dir
          return true
        }
        // 吃食物蛇加长
        eatFood() {
          this.data.push(this.lastData)
        }
      }
      {
        let map = document.querySelector('#map')
        let gameMap = new Map(map, 10)
        let gameFood = new Food(gameMap)
        let gameSnake = new Snake(gameMap, gameFood)
        gameMap.rander()
        setInterval(() => {
          gameSnake.move()
          gameMap.clearData()
          gameMap.setData(gameSnake.data)
          gameMap.rander()
        }, 200)
        setInterval(() => {
          gameSnake.changeDir('bottom')
          gameSnake.eatFood()
        }, 1000)
        setInterval(() => {
          gameSnake.changeDir('left')
          gameSnake.eatFood()
        }, 2000)
        setInterval(() => {
          gameSnake.changeDir('top')
          gameSnake.eatFood()
        }, 3000)
        setInterval(() => {
          gameSnake.changeDir('right')
          gameSnake.eatFood()
        }, 4000)
      }
    </script>
  </body>
</html>
